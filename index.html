<!DOCTYPE html>
<html lang="az">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Plinko â€” Real Fizika (SÉ™sli)</title>
    <style>
      :root {
        --bg: #0d47a1;
        --panel: #0b3b85;
        --text: #fff;
        --accent: #ffd600;
        --peg: #e3f2fd;
        --win: #00e676;
        --lose: #ff5252;
      }
      @media (max-width: 600px) {
        .legend .slot {
          padding: 2px;
          font-size: 9px;
        }
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
      }
      body {
        background: var(--bg);
        color: var(--text);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 10px;
      }
      header {
        padding: 12px 14px;
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 10px;
        align-items: center;
      }
      .stat {
        background: color-mix(in oklab, var(--panel), black 6%);
        border: 1px solid color-mix(in oklab, var(--panel), white 12%);
        border-radius: 14px;
        padding: 10px 12px;
        text-align: center;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.18);
      }
      .stat b {
        display: block;
        font-size: 12px;
        opacity: 0.85;
      }
      .stat span {
        font-weight: 800;
      }
      .bets {
        display: flex;
        gap: 8px;
        justify-content: center;
      }
      .chip {
        background: #ffca28;
        color: #1a1a1a;
        border: none;
        border-radius: 999px;
        padding: 8px 12px;
        font-weight: 800;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
      }
      .chip.active {
        outline: 3px solid rgba(255, 255, 255, 0.35);
      }
      main {
        padding: 0 12px;
      }
      #board {
        width: 100%;
        height: 60vh;
        max-height: 720px;
        background: var(--bg);
        border-radius: 22px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        box-shadow: inset 0 10px 28px rgba(0, 0, 0, 0.35);
        display: block;
      }
      .legend {
        display: flex;
        gap: 6px;
        padding: 8px 2px;
        font-weight: 800;
      }
      .legend .slot {
        flex: 1 1 auto;
        text-align: center;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 10px;
        padding: 6px;
      }
      footer {
        padding: 10px 14px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }
      #play {
        width: 100%;
        background: linear-gradient(180deg, #1e88e5, #1565c0);
        color: #fff;
        border: none;
        border-radius: 16px;
        font-weight: 900;
        letter-spacing: 0.3px;
        padding: 16px;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35),
          inset 0 1px 0 rgba(255, 255, 255, 0.25);
      }
      #play:disabled {
        opacity: 0.6;
        filter: grayscale(0.3);
      }
      #cashout {
        background: #ffca28;
        color: #1a1a1a;
        border: none;
        border-radius: 16px;
        font-weight: 900;
        letter-spacing: 0.3px;
        padding: 14px 20px;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
        width: 70%;
      }
      #addMoney {
        background: #00e676;
        color: #fff;
        border: none;
        border-radius: 12px;
        font-weight: 800;
        padding: 8px 14px;
        font-size: 14px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
        display: flex;
        align-items: center;
        gap: 6px;
      }
      #addMoney::before {
        content: "ðŸ’µ";
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="stat"><b>Balans</b><span id="bal">0.00 AZN</span></div>
      <div>
        <div class="bets" id="bets"></div>
        <div style="text-align: center; font-size: 12px; opacity: 0.9">
          MÉ™rc: <span id="betLbl">0.20</span> AZN
        </div>
      </div>
      <div class="stat"><b>UduÅŸ</b><span id="lastWin">0.00 AZN</span></div>
    </header>

    <main>
      <canvas id="board"></canvas>
      <div class="legend" id="legend"></div>
    </main>

    <footer>
      <button id="play">OYNA</button>
      <button id="cashout">PUL Ã‡IXART</button>
      <button id="addMoney">+ PUL</button>
    </footer>

    <script>
      document.getElementById("cashout").addEventListener("click", () => {
        window.location.href = "cashout.html";
      });

      // ==== ParametrlÉ™r ====
      const START_BALANCE = 10.0;
      const BET_OPTIONS = [0.2, 0.5, 1.0, 2];
      const MULTIPLIERS = [5, 3, 0.3, 0.2, 0.2, 0.3, 3, 5];
      const PEG_ROWS = 7;
      const GRAVITY = 0.35;
      const RESTITUTION = 0.65;
      const AIR_DRAG = 0.999;
      const MAX_VX = 4.2;
      const SUBSTEPS = 2;

      const canvas = document.getElementById("board");
      const ctx = canvas.getContext("2d");
      const balEl = document.getElementById("bal");
      const lastWinEl = document.getElementById("lastWin");
      const legendEl = document.getElementById("legend");
      const playBtn = document.getElementById("play");
      const betLbl = document.getElementById("betLbl");
      const betsWrap = document.getElementById("bets");
      const addBtn = document.getElementById("addMoney");

      let DPR = 1,
        W = 0,
        H = 0;
      let balance =
        parseFloat(localStorage.getItem("plinko_balance")) || START_BALANCE;
      let bet = BET_OPTIONS[0];
      let ball = null;
      let pegs = [],
        walls = [];
      let slotLineY = 0;

      // ==== Web Audio API (yumÅŸaq sÉ™s) ====
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      function playSound() {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "sine";
        osc.frequency.value = 700 + Math.random() * 250;
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(
          0.001,
          audioCtx.currentTime + 0.15
        );
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.15);
      }

      function saveBalance() {
        localStorage.setItem("plinko_balance", balance.toFixed(2));
      }
      function formatAZN(v) {
        return v.toFixed(2) + " AZN";
      }

      function setBet(v) {
        bet = v;
        betLbl.textContent = bet.toFixed(2);
        Array.from(betsWrap.children).forEach((btn) => {
          const val = +btn.dataset.v;
          btn.classList.toggle("active", Math.abs(val - bet) < 1e-6);
        });
        updateButtons();
      }
      function updateHUD(win = 0) {
        balEl.textContent = formatAZN(balance);
        lastWinEl.textContent = formatAZN(win);
        updateButtons();
        saveBalance();
      }
      function updateButtons() {
        playBtn.disabled = balance < bet; // << dÃ¼zÉ™liÅŸ olundu
      }

      BET_OPTIONS.forEach((v) => {
        const b = document.createElement("button");
        b.className = "chip";
        b.textContent = v.toFixed(2);
        b.dataset.v = v;
        b.onclick = () => setBet(v);
        betsWrap.appendChild(b);
      });

      function sizeCanvas() {
        DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
        const rect = canvas.getBoundingClientRect();
        W = Math.floor(rect.width);
        H = Math.max(340, Math.floor(rect.height));
        canvas.width = Math.floor(W * DPR);
        canvas.height = Math.floor(H * DPR);
        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
        buildBoard();
      }

      function buildBoard() {
        pegs = [];
        const marginX = 26,
          topY = 40,
          bottomMargin = 70;
        const usableW = W - marginX * 2;
        const rowGap = (H - topY - bottomMargin) / PEG_ROWS;
        const colsTop = 1,
          pegR = 4.5;
        for (let r = 0; r < PEG_ROWS; r++) {
          const cols = colsTop + r;
          const gap = usableW / (cols - 1);
          const y = topY + r * rowGap;
          for (let c = 0; c < cols; c++) {
            const x = marginX + c * gap;
            pegs.push({ x, y, r: pegR });
          }
        }
        walls = [
          { x: marginX - 6, y1: topY - 10, y2: H - 60 },
          { x: W - (marginX - 6), y1: topY - 10, y2: H - 60 },
        ];
        slotLineY = H - 60;
        drawStatic();
      }

      function drawStatic() {
        ctx.clearRect(0, 0, W, H);
        ctx.fillStyle =
          getComputedStyle(document.documentElement).getPropertyValue(
            "--peg"
          ) || "#e3f2fd";
        pegs.forEach((p) => {
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          ctx.fill();
        });
        ctx.strokeStyle = "rgba(255,255,255,.25)";
        ctx.lineWidth = 2;
        walls.forEach((w) => {
          ctx.beginPath();
          ctx.moveTo(w.x, w.y1);
          ctx.lineTo(w.x, w.y2);
          ctx.stroke();
        });
        const n = MULTIPLIERS.length;
        const slotW = W / n;
        ctx.beginPath();
        ctx.moveTo(0, slotLineY);
        ctx.lineTo(W, slotLineY);
        ctx.stroke();
        for (let i = 0; i <= n; i++) {
          ctx.beginPath();
          ctx.moveTo(i * slotW, slotLineY);
          ctx.lineTo(i * slotW, H);
          ctx.stroke();
        }
        legendEl.innerHTML = "";
        MULTIPLIERS.forEach((m) => {
          const d = document.createElement("div");
          d.className = "slot";
          d.textContent = m.toFixed(2) + "Ã—";
          d.style.color =
            m > 1 ? "var(--win)" : m === 0 ? "var(--lose)" : "#fff";
          legendEl.appendChild(d);
        });
      }

      function reflectVelocity(vx, vy, nx, ny) {
        const dot = vx * nx + vy * ny;
        vx = vx - (1 + RESTITUTION) * dot * nx;
        vy = vy - (1 + RESTITUTION) * dot * ny;
        return [vx, vy];
      }
      function clamp(v, min, max) {
        return Math.max(min, Math.min(max, v));
      }

      function dropBall() {
        ball = {
          x: W / 2,
          y: 18,
          vx: 0,
          vy: 0,
          r: 7.5,
          settled: false,
          hitFloor: false,
        };
        updateButtons();
      }

      function settleAndPay() {
        const n = MULTIPLIERS.length;
        const slotW = W / n;
        let idx = Math.floor(clamp(ball.x, 0, W - 1) / slotW);
        idx = clamp(idx, 0, n - 1);
        const mult = MULTIPLIERS[idx];
        const win = +(bet * mult).toFixed(2);
        balance = +(balance + win).toFixed(2);
        updateHUD(win);
        ball = null;
      }

      function step(dt) {
        if (!ball) return;
        for (let s = 0; s < SUBSTEPS; s++) {
          ball.vy += GRAVITY * (dt / SUBSTEPS);
          ball.x += ball.vx;
          ball.y += ball.vy;
          walls.forEach((w) => {
            if (ball.y > w.y1 && ball.y < w.y2) {
              const side = w.x < W / 2 ? 1 : -1;
              if (Math.abs(ball.x - w.x) < ball.r) {
                const nx = side,
                  ny = 0;
                ball.x = w.x + side * ball.r;
                [ball.vx, ball.vy] = reflectVelocity(ball.vx, ball.vy, nx, ny);
                playSound();
              }
            }
          });
          for (let i = 0; i < pegs.length; i++) {
            const p = pegs[i];
            const dx = ball.x - p.x,
              dy = ball.y - p.y;
            const dist = Math.hypot(dx, dy);
            const minD = ball.r + p.r;
            if (dist < minD) {
              let nx = dx / (dist || 1e-6),
                ny = dy / (dist || 1e-6);
              const overlap = minD - dist;
              ball.x += nx * overlap;
              ball.y += ny * overlap;
              [ball.vx, ball.vy] = reflectVelocity(ball.vx, ball.vy, nx, ny);
              ball.vx += (Math.random() - 0.5) * 0.6;
              playSound();
            }
          }
          if (ball.y + ball.r > slotLineY) {
            ball.y = slotLineY - ball.r;
            ball.vy = -ball.vy * RESTITUTION * 0.35;
            ball.vx *= 0.98;
            if (!ball.hitFloor) {
              playSound();
              ball.hitFloor = true;
            }
            if (Math.hypot(ball.vx, ball.vy) < 0.35) {
              ball.settled = true;
            }
          }
          ball.vx = clamp(ball.vx * AIR_DRAG, -MAX_VX, MAX_VX);
          ball.vy = ball.vy * AIR_DRAG;
        }
        if (ball && ball.settled) {
          settleAndPay();
        }
      }

      function draw() {
        drawStatic();
        if (ball) {
          ctx.beginPath();
          ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
          ctx.fillStyle =
            getComputedStyle(document.documentElement).getPropertyValue(
              "--accent"
            ) || "#ffd600";
          ctx.shadowColor = "rgba(0,0,0,.35)";
          ctx.shadowBlur = 8;
          ctx.fill();
          ctx.shadowBlur = 0;
        }
      }

      let last = 0;
      function loop(ts) {
        const dt = Math.min(32, ts - last || 16);
        last = ts;
        step(dt / 16.6667);
        draw();
        requestAnimationFrame(loop);
      }

      playBtn.addEventListener("click", () => {
        if (balance < bet) return;
        balance = +(balance - bet).toFixed(2);
        updateHUD(0);
        dropBall();
      });

      addBtn.addEventListener("click", () => {
        balance = +(balance + 0).toFixed(2);
        updateHUD(0);
      });

      window.addEventListener("resize", sizeCanvas);

      sizeCanvas();
      setBet(bet);
      updateHUD(0);
      requestAnimationFrame(loop);
    </script>
  </body>
</html>
